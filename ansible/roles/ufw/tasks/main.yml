- name: ufwのインストール
  become: yes
  apt:
    name: ufw
  when: not ansible_check_mode

- name: ufwの基本設定
  become: yes
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - direction: incoming
      policy: deny
    - direction: outgoing
      policy: allow
  when: not ansible_check_mode

- name: ufwの開放ポートの設定
  become: yes
  ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
  loop:
    - rule: limit
      port: 22
      proto: tcp
    - rule: allow
      port: 80
      proto: tcp
    - rule: allow
      port: 443
      proto: tcp
  when: not ansible_check_mode

- name: ufwのログを有効化
  become: yes
  ufw:
    logging: on
  when: not ansible_check_mode

- name: ufwを有効化
  become: yes
  ufw:
    state: enabled
  when: not ansible_check_mode
